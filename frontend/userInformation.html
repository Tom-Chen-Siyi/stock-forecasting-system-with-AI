<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Change Password & View Deposit</title>
    <link rel="stylesheet" href="multipleStockAnalysis.css">
</head>
<body>
<div id="navbar-container"></div>

<h1>User information</h1>
    <div class="change password and view deposit">
 <div class="main-container">
<div class="container">
    <h2>Change Password</h2>
    <form id="change-password-form">

        <label for="oldPassword">Old Password:</label>
        <input type="password" id="oldPassword" placeholder="Enter your old password" required>

        <label for="newPassword">New Password:</label>
        <input type="password" id="newPassword" placeholder="Enter your new password" required>

        <button type="submit">Change Password</button>
    </form>
    <div class="message" id="change-password-message"></div>
</div>

<div class="container">
    <h2>Deposit Amount</h2>
    <form id="deposit-form">
        <label for="amount">Amount:</label>
        <input type="number" id="amount" placeholder="Enter amount to deposit" min="1" required>

        <button type="submit">Deposit</button>
    </form>
    <div class="message" id="deposit-message"></div>
</div>
     <div class="container">
         <h2>Sell Stock</h2>
         <div class="form-group">
             <label for="timestamp">Timestamp:</label>
             <input type="text" id="timestamp" placeholder="Enter timestamp">
         </div>
         <div class="form-group">
             <label for="sellQuantity">Sell Quantity:</label>
             <input type="number" id="sellQuantity" placeholder="Enter sell quantity">
         </div>
         <button class="btn" id="submitBtn">Submit</button>
         <div id="message" class="message"></div>
     </div>
<p id="active-stocks-message"></p>

<table id="active-stocks-table" style="display:none;">
    <thead>
    <tr>
        <th>Timestamp</th>
        <th>Stock Name</th>
        <th>Quantity</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>
    </div>
    <div class="sell stock">

    </div>
</div>

<script>
    // Change Password Form
    document.getElementById('change-password-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const oldPassword = document.getElementById('oldPassword').value;
        const newPassword = document.getElementById('newPassword').value;

        try {
            const response = await fetch('http://localhost:3000/api/change-password', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ oldPassword, newPassword }),
                credentials: 'include',
            });
            const result = await response.json();
            const messageEl = document.getElementById('change-password-message');
            if (result.success) {
                messageEl.textContent = result.message;
                messageEl.classList.remove('error');
                alert("changing password successful")
            } else {
                messageEl.textContent = result.message;
                messageEl.classList.add('error');
            }
        } catch (error) {
            console.error('Error changing password:', error);
            alert('Error changing password. Please try again later.');
        }
    });

    // Deposit Form
    document.getElementById('deposit-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const amount = parseFloat(document.getElementById('amount').value);

        try {
            const response = await fetch('http://localhost:3000/api/deposit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount }),
                credentials: 'include',
            });
            const result = await response.json();
            const messageEl = document.getElementById('deposit-message');
            if (result.success) {
                messageEl.textContent = result.message;
                messageEl.classList.remove('error');
                alert("deposit successful")
            } else {
                messageEl.textContent = result.message;
                messageEl.classList.add('error');
            }
        } catch (error) {
            console.error('Error processing deposit:', error);
            alert('Error processing deposit. Please try again later.');
        }
    });

    document.addEventListener('DOMContentLoaded', async () => {
        const messageEl = document.getElementById('active-stocks-message');
        const tableEl = document.getElementById('active-stocks-table');
        const tbodyEl = tableEl.querySelector('tbody');

        try {
            const response = await fetch('http://localhost:3000/api/active-stocks', {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
            });

            const result = await response.json();

            if (response.ok) {
                messageEl.textContent = result.message;
                messageEl.classList.add('success');
                messageEl.classList.remove('error');

                // fill the stock data
                result.data.forEach(stock => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                            <td>${stock.timestamp}</td>
                            <td>${stock.stock_name}</td>
                            <td>${stock.number}</td>
                        `;
                    tbodyEl.appendChild(row);
                });

                tableEl.style.display = 'table';
            } else {
                messageEl.textContent = result.message || 'Failed to load active stocks';
                messageEl.classList.add('error');
                messageEl.classList.remove('success');
            }
        } catch (error) {
            console.error('Error fetching active stocks:', error);
            messageEl.textContent = 'Error fetching active stocks. Please try again later.';
            messageEl.classList.add('error');
            messageEl.classList.remove('success');
        }
    });

    document.getElementById('submitBtn').addEventListener('click', async () => {
        const timestamp = document.getElementById('timestamp').value;
        const sellQuantity = document.getElementById('sellQuantity').value;

        const messageDiv = document.getElementById('message');
        messageDiv.textContent = '';
        messageDiv.className = 'message';

        if (!timestamp || !sellQuantity || sellQuantity <= 0) {
            messageDiv.textContent = 'Please enter valid inputs.';
            messageDiv.classList.add('error');
            return;
        }

        try {
            // Send a POST request to the backend.
            const response = await fetch('http://localhost:3000/api/sell-stock', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ timestamp, sellQuantity }),
                credentials: 'include',
            });

            const data = await response.json();

            if (response.ok) {

                messageDiv.textContent = `Success: ${data.message}. Sold for ${data.sellAmount.toFixed(2)} with real-time price ${data.realTimePrice.toFixed(2)}. Remaining: ${data.remainingQuantity}.`;
                messageDiv.classList.add('success');
                alert(messageDiv.textContent)
            } else {

                messageDiv.textContent = `Error: ${data.error || 'Unknown error'}`;
                messageDiv.classList.add('error');
            }
        } catch (error) {

            messageDiv.textContent = 'Error: Failed to connect to the server.';
            messageDiv.classList.add('error');
        }
    });

    window.onload = function() {

        fetch('navbar.html')
            .then(response => response.text())
            .then(data => {

                document.getElementById('navbar-container').innerHTML = data;
            })
            .catch(error => {
                console.error('Error loading navbar:', error);
            });
    };
</script>
</body>
</html>
